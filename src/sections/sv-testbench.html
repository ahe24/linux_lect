<section id="sv-testbench" class="content-section">

    <h1>Practical SV Testbench (for Designers)</h1>
    <p>UVMê³¼ ê°™ì€ ë³µì¡í•œ ë°©ë²•ë¡  ì—†ì´ë„, <strong>SystemVerilogì˜ í•µì‹¬ ë¬¸ë²•(Task, Fork)</strong>ë§Œ í™œìš©í•˜ë©´ ê°€ë…ì„±ê³¼ ìƒì‚°ì„±ì„ 10ë°° ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <style>
        /* í°íŠ¸ í•©ì(Ligature) ë°©ì§€: <= ê°€ íŠ¹ìˆ˜ê¸°í˜¸ë¡œ ë³€í•˜ëŠ” ê²ƒ ë°©ì§€ */
        code,
        pre {
            font-variant-ligatures: none !important;
        }
    </style>

    <h2>1. ì§€ì €ë¶„í•œ 'Initial' ë¸”ë¡ íƒˆì¶œí•˜ê¸° (Task í™œìš©)</h2>
    <p>ëª¨ë“  ì‹ í˜¸ ì œì–´ë¥¼ `initial begin ... end` ì•ˆì— ë•Œë ¤ ë„£ìœ¼ë©´ ìŠ¤íŒŒê²Œí‹° ì½”ë“œê°€ ë©ë‹ˆë‹¤. <strong>Task</strong>ë¡œ ë™ì‘ì„ ëª¨ë“ˆí™”í•˜ì„¸ìš”.</p>
    <pre><code class="language-verilog">// ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì“°ê¸° ë™ì‘ ì •ì˜
task bus_write(input logic [31:0] addr, input logic [31:0] data);
    begin
        @ (posedge clk);
        cs_n     &lt;= 0;
        rw_n     &lt;= 0; // Write
        addr_bus &lt;= addr;
        data_bus &lt;= data;
        @ (posedge clk);
        cs_n     &lt;= 1; // End cycle
    end
endtask</code></pre>

    <h2>2. ê²€ì¦ì˜ í•µì‹¬: Fork-Join ì‹œê°í™” ë° íŒ¨í„´</h2>
    <p>ë³‘ë ¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ì œì–´í•˜ëŠ” 3ê°€ì§€ ë°©ì‹ì˜ ì°¨ì´ì ê³¼ <strong>"ë„ëŒ€ì²´ ì–¸ì œ ì“°ëŠ”ê°€?"</strong>ì— ëŒ€í•œ ì‹¤ì „ ì˜ˆì‹œì…ë‹ˆë‹¤.</p>

    <style>
        .fork-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            font-size: 0.9em;
            font-family: 'JetBrains Mono', monospace;
        }

        .fork-table th,
        .fork-table td {
            border: 1px solid #444;
            padding: 8px;
            text-align: center;
        }

        .fork-table th {
            background: #222;
            color: #fff;
            width: 80px;
        }

        .state-run {
            background: #2e7d32;
            color: #fff;
            border-radius: 4px;
        }

        .state-wait {
            background: #424242;
            color: #aaa;
            border-radius: 4px;
            font-style: italic;
        }

        .desc-box {
            margin-top: 30px;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--accent-color);
            font-size: 1.1em;
        }

        .code-snippet-box {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--accent-color);
            padding: 10px;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .code-snippet-title {
            color: #aaa;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
    </style>

    <!-- Diagram 1: Join -->
    <div class="desc-box"><i data-lucide="git-merge"></i> 1. fork ... join (ëª¨ë‘ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°)</div>
    <table class="fork-table">
        <tr>
            <th>Main</th>
            <td class="state-run">Start</td>
            <td class="state-wait" colspan="2">Wait (ë©ˆì¶¤)</td>
            <td class="state-run">Resume</td>
        </tr>
        <tr>
            <th>Proc A</th>
            <td></td>
            <td class="state-run">Run (10ns)</td>
            <td>Ends</td>
            <td></td>
        </tr>
        <tr>
            <th>Proc B</th>
            <td></td>
            <td class="state-run" colspan="2">Run (20ns) ...........</td>
            <td>Ends</td>
        </tr>
    </table>
    <div class="code-snippet-box">
        <span class="code-snippet-title">ğŸ’¡ [ì‚¬ìš© ì˜ˆì‹œ] ë‹¤ì¤‘ í¬íŠ¸ ë™ì‹œ ì œì–´</span>
        <p>ë‘ ê°œì˜ ë§ˆìŠ¤í„°ê°€ ë™ì‹œì— ë©”ëª¨ë¦¬ì— ì ‘ê·¼í•˜ëŠ” ìƒí™©ì„ í…ŒìŠ¤íŠ¸í•  ë•Œ ì”ë‹ˆë‹¤.</p>
        <pre style="margin:5px 0;"><code class="language-verilog">fork
    drive_port_a(); // 10ms ì†Œìš”
    drive_port_b(); // 20ms ì†Œìš”
join // ê°€ì¥ ëŠ¦ê²Œ ëë‚˜ëŠ” Bê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
$display("ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¢…ë£Œ");</code></pre>
    </div>


    <!-- Diagram 2: Join Any -->
    <div class="desc-box"><i data-lucide="git-branch-plus"></i> 2. fork ... join_any (1ë“± ë„ì°© ì‹œ ì¶œë°œ)</div>
    <table class="fork-table">
        <tr>
            <th>Main</th>
            <td class="state-run">Start</td>
            <td class="state-wait">Wait</td>
            <td class="state-run" colspan="2">Resume (A ëë‚˜ìë§ˆì ì¶œë°œ!)</td>
        </tr>
        <tr>
            <th>Proc A</th>
            <td></td>
            <td class="state-run">Run (10ns)</td>
            <td>Ends</td>
            <td></td>
        </tr>
        <tr>
            <th>Proc B</th>
            <td></td>
            <td class="state-run" colspan="2">Run (20ns) ...........</td>
            <td>(ê³„ì† ë”)</td>
        </tr>
    </table>
    <div class="code-snippet-box">
        <span class="code-snippet-title">ğŸ’¡ [ì‚¬ìš© ì˜ˆì‹œ] íƒ€ì„ì•„ì›ƒ(Watchdog) êµ¬í˜„</span>
        <p>ì‘ì—…ì´ ì™„ë£Œë˜ê±°ë‚˜, í˜¹ì€ ì‹œê°„ì´ ì´ˆê³¼ë˜ê±°ë‚˜. ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ë°œìƒí•˜ë©´ ë„˜ì–´ê°‘ë‹ˆë‹¤.</p>
        <pre style="margin:5px 0;"><code class="language-verilog">fork
    wait_for_interrupt(); // ì–¸ì  ê°€ ë°œìƒí•  ì¸í„°ëŸ½íŠ¸
    #10000;               // 10us íƒ€ì„ì•„ì›ƒ
join_any // ì¸í„°ëŸ½íŠ¸ê°€ ì˜¤ê±°ë‚˜ 10usê°€ ì§€ë‚˜ë©´ ì¦‰ì‹œ ë‹¤ìŒìœ¼ë¡œ ì§„í–‰
if (timed_out) $error("Timeout Error!");</code></pre>
    </div>

    <!-- Diagram 3: Join None -->
    <div class="desc-box"><i data-lucide="git-branch"></i> 3. fork ... join_none (ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)</div>
    <table class="fork-table">
        <tr>
            <th>Main</th>
            <td class="state-run">Start</td>
            <td class="state-run" colspan="3">Resume (ë°”ë¡œ ì¶œë°œ!)</td>
        </tr>
        <tr>
            <th>Proc A</th>
            <td></td>
            <td class="state-run">Run (10ns)</td>
            <td>Ends</td>
            <td></td>
        </tr>
        <tr>
            <th>Proc B</th>
            <td></td>
            <td class="state-run" colspan="2">Run (20ns) ...........</td>
            <td>(ê³„ì† ë”)</td>
        </tr>
    </table>
    <div class="code-snippet-box">
        <span class="code-snippet-title">ğŸ’¡ [ì‚¬ìš© ì˜ˆì‹œ] ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… (í´ëŸ­, ëª¨ë‹ˆí„°)</span>
        <p>ë©”ì¸ ì‹œë‚˜ë¦¬ì˜¤ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  ë’¤ì—ì„œ ê³„ì† ëŒì•„ì•¼ í•˜ëŠ” ì‘ì—…ë“¤ì…ë‹ˆë‹¤.</p>
        <pre style="margin:5px 0;"><code class="language-verilog">fork
    forever #5 clk = ~clk; // í´ëŸ­ ìƒì„± (ë¬´í•œë£¨í”„)
    monitor_bus();         // ë²„ìŠ¤ ê°ì‹œ (ë¬´í•œë£¨í”„)
join_none // ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ! ë°”ë¡œ ì•„ë˜ ë¦¬ì…‹ ë¡œì§ ì‹¤í–‰

#100 rst_n = 1; // ë³‘ë ¬ í”„ë¡œì„¸ìŠ¤ë“¤ì´ ë„ëŠ” ë™ì•ˆ ì‹¤í–‰ë¨</code></pre>
    </div>

    <h2>3. ì „ì²´ í†µí•© ì½”ë“œ (DUT + Stimulus + Monitor)</h2>
    <pre><code class="language-verilog">`timescale 1ns/1ps

module tb_top;
    logic        clk, rst_n;
    logic [31:0] addr, wdata, rdata;
    logic        we, en;

    // DUT ì—°ê²°
    my_memory_ctrl u_dut (
        .clk(clk), .rst_n(rst_n),
        .addr(addr), .wdata(wdata), .rdata(rdata),
        .we(we), .en(en)
    );

    // Driver Task
    task drive_write(input [31:0] a, input [31:0] d);
        @ (posedge clk);
        en    &lt;= 1; 
        we    &lt;= 1;
        addr  &lt;= a; 
        wdata &lt;= d;
        @ (posedge clk);
        en    &lt;= 0; 
        we    &lt;= 0;
    endtask

    task drive_read(input [31:0] a);
        @ (posedge clk);
        en   &lt;= 1; 
        we   &lt;= 0;
        addr &lt;= a;
        @ (posedge clk);
        en   &lt;= 0;
    endtask

    // Monitor Task
    task monitor();
        forever begin
            @ (posedge clk);
            if (en && !we) begin
                #1; 
                $display("[MON] Read Addr: %h, Data: %h", addr, rdata);
            end
        end
    endtask

    // Main Scenario
    initial begin
        clk = 0; rst_n = 0;
        en = 0; we = 0; addr = 0; wdata = 0;

        // Background Jobs
        fork
            forever #5 clk = ~clk; 
            monitor();             
        join_none                  

        #20 rst_n = 1;

        $display("--- Start Test ---");
        drive_write(32'h100, 32'h1234_5678);
        drive_write(32'h104, 32'hDEAD_BEEF);
        
        #50;
        drive_read(32'h100);
        drive_read(32'h104);

        $display("--- Test Done ---");
        $finish;
    end

endmodule</code></pre>

    <h2>4. ì‹¤ì „ ì‹œë‚˜ë¦¬ì˜¤ ë”ë³´ê¸° (Advanced Scenarios)</h2>
    <p>í˜„ì—…ì—ì„œ ìì£¼ ë§ˆì£¼ì¹˜ëŠ” íŒ¨í‚· ìƒì„±ê³¼ ì•Œê³ ë¦¬ì¦˜ ê²€ì¦ íŒ¨í„´ì…ë‹ˆë‹¤.</p>

    <div class="code-snippet-box">
        <span class="code-snippet-title">ğŸ¯ ì‹œë‚˜ë¦¬ì˜¤ A: ê°€ë³€ ê¸¸ì´ íŒ¨í‚· ìƒì„± (Packet Generator)</span>
        <p><code>struct</code>ì™€ <code>dynamic array</code>ë¥¼ í™œìš©í•˜ë©´ Cì–¸ì–´ì²˜ëŸ¼ ì§ê´€ì ìœ¼ë¡œ íŒ¨í‚·ì„ êµ¬ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <pre style="margin:5px 0;"><code class="language-verilog">// íŒ¨í‚· í—¤ë” êµ¬ì¡°ì²´ ì •ì˜
typedef struct packed {
    logic [7:0] msg_id;
    logic [7:0] dest_id;
    logic [7:0] len;
} header_t;

// 1. ë‹¨ì¼ íŒ¨í‚· ìƒì„± ë° ì „ì†¡ (ë°ì´í„°ë§Œ ëœë¤)
task gen_packet(input logic [7:0] id, input logic [7:0] dest, input logic [7:0] len);
    header_t hdr;
    logic [7:0] payload[];

    // í—¤ë” ì„¤ì •
    hdr.msg_id  = id;
    hdr.dest_id = dest;
    hdr.len     = len;
    
    // í˜ì´ë¡œë“œ ëœë¤ ìƒì„±
    payload = new[hdr.len];
    foreach(payload[i]) payload[i] = $urandom;

    // ì „ì†¡ ì‹œì‘ (íŒ¨í‚· ìœ íš¨ ì‹ í˜¸ ì¸ê°€)
    @ (posedge clk);
    pkt_valid <= 1; // Valid High
    
    $display("[PKT] ID:%h -> Dest:%h (Len:%0d)", hdr.msg_id, hdr.dest_id, hdr.len);
    
    send_byte(hdr.msg_id);
    send_byte(hdr.dest_id);
    send_byte(hdr.len);
    foreach(payload[i]) send_byte(payload[i]);
    
    @ (posedge clk);
    pkt_valid <= 0; // Valid Low
endtask

// 2. ìƒìœ„ ì‹œë‚˜ë¦¬ì˜¤: ë‹¤ì–‘í•œ íŒ¨í‚· ì¸ê°€
task run_packet_stream();
    // Case 1: ì§§ì€ íŒ¨í‚·
    gen_packet(8'hA1, 8'h01, 8'd4);
    
    // Case 2: ê¸´ íŒ¨í‚·
    gen_packet(8'hB2, 8'h02, 8'd16);
    
    // Case 3: ëœë¤ IDë¡œ 5íšŒ ë°˜ë³µ
    repeat(5) begin
        gen_packet($urandom, 8'hFF, $urandom_range(4, 8));
    end
endtask</code></pre>
    </div>

    <div class="code-snippet-box">
        <span class="code-snippet-title">ğŸ“ ì‹œë‚˜ë¦¬ì˜¤ B: ë ˆì´ë” ì‹ í˜¸ ì „ë ¥(Energy) ê³„ì‚° ê²€ì¦</span>
        <p>ë³µì†Œìˆ˜ ì‹ í˜¸(I/Q)ì˜ ì „ë ¥(<code>IÂ² + QÂ²</code>)ì„ êµ¬í•˜ëŠ” DSP ë¡œì§ì„ ê²€ì¦í•©ë‹ˆë‹¤. <strong>out_valid</strong> ì‹ í˜¸ê°€ ëœ° ë•Œë§Œ ë°ì´í„°ë¥¼ ìº¡ì²˜í•˜ì—¬ ë¹„êµí•˜ëŠ”
            ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.</p>
        <pre style="margin:5px 0;"><code class="language-verilog">// ì •ë‹µì„ ì €ì¥í•  í (Scoreboard ì—­í• )
real expected_q[$]; 

// 1. ì…ë ¥ ìƒì„± ë° ì •ë‹µ ê³„ì‚° (Driver)
task drive_radar_stimulus(int count);
    real i_real, q_real, exp_energy;
    logic signed [15:0] i_data, q_data;

    repeat(count) begin
        @ (posedge clk);
        // ëœë¤ ë°ì´í„° ìƒì„±
        i_data = $urandom; 
        q_data = $urandom;
        
        // ì‹ í˜¸ ì¸ê°€
        valid_in <= 1;
        i_in     <= i_data;
        q_in     <= q_data;

        // Golden Model ê³„ì‚° ë° íì— ì €ì¥ (Push Pipeline)
        i_real = i_data / 32768.0;
        q_real = q_data / 32768.0;
        exp_energy = (i_real * i_real) + (q_real * q_real);
        
        expected_q.push_back(exp_energy);
    end
    
    @ (posedge clk);
    valid_in <= 0;
endtask

// 2. ì¶œë ¥ ëª¨ë‹ˆí„°ë§ ë° ë¹„êµ (Monitor)
task monitor_radar_result();
    real exp_val, dut_val, error;

    forever begin
        @ (posedge clk);
        if (out_valid) begin
            // íì—ì„œ ì •ë‹µ êº¼ë‚´ê¸° (Pop Pipeline)
            if (expected_q.size() == 0) begin
                $error("[ERR] Unexpected output data!");
                continue;
            end
            exp_val = expected_q.pop_front();
            
            // DUT ê²°ê³¼ ë³€í™˜
            dut_val = energy_out / (32768.0 * 32768.0);
            
            // ì˜¤ì°¨ ê²€ì¦
            error = (dut_val > exp_val) ? (dut_val - exp_val) : (exp_val - dut_val);
            if (error > 0.01) $error("Mismatch! Exp:%.5f Got:%.5f", exp_val, dut_val);
            else              $display("Pass! Exp:%.5f Got:%.5f", exp_val, dut_val);
        end
    end
endtask

// 3. ë©”ì¸ ì‹¤í–‰ (Fork-Join í™œìš©)
initial begin
    fork
        monitor_radar_result();      // ëª¨ë‹ˆí„°ëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ë™ì‘
        drive_radar_stimulus(100);   // 100ê°œ ìƒ˜í”Œ ì¸ê°€
    join_any // Stimulusê°€ ëë‚˜ë©´ ì¢…ë£Œ
    
    // ë‚¨ì€ íŒŒì´í”„ë¼ì¸ ì²˜ë¦¬ ëŒ€ê¸°
    wait(expected_q.size() == 0);
    $finish;
end</code></pre>
    </div>

</section>